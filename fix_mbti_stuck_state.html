<!DOCTYPE html>
<html>
<head>
    <title>Fix MBTI Stuck State</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { border: 1px solid #ccc; margin: 10px 0; padding: 15px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        pre { background-color: #f8f9fa; padding: 10px; overflow-x: auto; }
        input { width: 500px; padding: 8px; margin: 5px; }
        .step { background: #e9ecef; padding: 10px; margin: 5px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>ğŸ”§ Fix MBTI Stuck State</h1>

    <div class="section warning">
        <h2>âš ï¸ Problem Diagnosed</h2>
        <p>You have an MBTI test in "in_progress" state with 0% completion, but there are no questions in the database. This causes the "è¨ºæ–­ã‚’ç¶šã‘ã‚‹ (0%)" button that doesn't work.</p>
        <p><strong>Solution:</strong> We need to reset your test state AND add questions.</p>
    </div>

    <div class="section">
        <h2>ğŸ”‘ Authentication</h2>
        <p>Paste your authentication token from the frontend:</p>
        <input type="text" id="auth-token" placeholder="Paste your accessToken here">
        <br>
        <button onclick="testAuth()">Test Authentication</button>
        <div id="auth-result"></div>
    </div>

    <div class="section">
        <h2>ğŸ” Step 1: Check Current State</h2>
        <button onclick="checkCurrentState()">Check MBTI Progress</button>
        <div id="state-result"></div>
    </div>

    <div class="section">
        <h2>ğŸ—‘ï¸ Step 2: Reset Test State</h2>
        <p>This will clear your stuck test and allow you to start fresh.</p>
        <button onclick="resetTestState()">Reset My MBTI Test</button>
        <div id="reset-result"></div>
    </div>

    <div class="section">
        <h2>â• Step 3: Add Sample Questions (Admin Only)</h2>
        <p>You need admin access to add questions. If you're not an admin, ask an admin to do this step.</p>
        <button onclick="addSampleQuestions()">Add 5 Sample Questions</button>
        <div id="questions-result"></div>
    </div>

    <div class="section">
        <h2>âœ… Step 4: Test the Fix</h2>
        <button onclick="testFinalState()">Verify MBTI is Fixed</button>
        <div id="final-result"></div>
    </div>

    <script>
        const BACKEND_URL = 'http://localhost:8000';

        function showResult(elementId, content, className = 'success') {
            const element = document.getElementById(elementId);
            element.innerHTML = content;
            element.className = className;
        }

        async function testAuth() {
            const token = document.getElementById('auth-token').value.trim();
            if (!token) {
                showResult('auth-result', 'âŒ Please paste your authentication token first', 'error');
                return false;
            }

            try {
                const response = await fetch(`${BACKEND_URL}/api/users/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const user = await response.json();
                    const roles = user.roles || [];
                    const primaryRole = roles[0]?.role?.name || 'No role assigned';
                    showResult('auth-result', `âœ… Authentication successful! User: ${user.full_name || user.email}, Role: ${primaryRole}`);
                    return true;
                } else {
                    showResult('auth-result', `âŒ Authentication failed: ${response.status}`, 'error');
                    return false;
                }
            } catch (error) {
                showResult('auth-result', `âŒ Auth test failed: ${error.message}`, 'error');
                return false;
            }
        }

        async function checkCurrentState() {
            const token = document.getElementById('auth-token').value.trim();
            if (!token) {
                showResult('state-result', 'âŒ Please test authentication first', 'error');
                return;
            }

            try {
                const response = await fetch(`${BACKEND_URL}/api/mbti/progress`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const progress = await response.json();
                    showResult('state-result',
                        `Current MBTI State:<br>
                        Status: ${progress.status}<br>
                        Completion: ${progress.completion_percentage}%<br>
                        Current Question: ${progress.current_question || 'None'}<br>
                        Total Questions: ${progress.total_questions}<br>
                        Started At: ${progress.started_at || 'Never'}<br><br>
                        ${progress.status === 'in_progress' && progress.completion_percentage === 0
                            ? 'âš ï¸ <strong>Problem confirmed: Stuck in progress with 0% completion</strong>'
                            : 'âœ… State looks normal'}`);
                } else {
                    showResult('state-result', `âŒ Failed to get progress: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('state-result', `âŒ Error checking state: ${error.message}`, 'error');
            }
        }

        async function resetTestState() {
            const token = document.getElementById('auth-token').value.trim();
            if (!token) {
                showResult('reset-result', 'âŒ Please test authentication first', 'error');
                return;
            }

            try {
                showResult('reset-result', 'â³ Resetting your MBTI test state...', 'warning');

                // Try to start a new test (this should reset the existing one)
                const response = await fetch(`${BACKEND_URL}/api/mbti/start`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ language: 'ja' })
                });

                if (response.ok) {
                    const result = await response.json();
                    showResult('reset-result',
                        `âœ… Test state reset successfully!<br>
                        New Status: ${result.status}<br>
                        Completion: ${result.completion_percentage}%<br>
                        Ready for questions!`);
                } else {
                    const error = await response.text();
                    showResult('reset-result', `âŒ Failed to reset: ${response.status} - ${error}`, 'error');
                }
            } catch (error) {
                showResult('reset-result', `âŒ Error resetting state: ${error.message}`, 'error');
            }
        }

        async function addSampleQuestions() {
            const token = document.getElementById('auth-token').value.trim();
            if (!token) {
                showResult('questions-result', 'âŒ Please test authentication first', 'error');
                return;
            }

            const sampleQuestions = [
                {
                    question_number: 1,
                    dimension: "E_I",
                    question_text_en: "Do you prefer working in groups or alone?",
                    question_text_ja: "ã‚°ãƒ«ãƒ¼ãƒ—ã§åƒãã“ã¨ã¨ä¸€äººã§åƒãã“ã¨ã€ã©ã¡ã‚‰ã‚’å¥½ã¿ã¾ã™ã‹ï¼Ÿ",
                    option_a_en: "I love working in groups and collaborating",
                    option_a_ja: "ã‚°ãƒ«ãƒ¼ãƒ—ã§åƒãã€å”åŠ›ã™ã‚‹ã“ã¨ãŒå¤§å¥½ãã§ã™",
                    option_a_trait: "E",
                    option_b_en: "I prefer working alone and focusing deeply",
                    option_b_ja: "ä¸€äººã§åƒãã€æ·±ãé›†ä¸­ã™ã‚‹ã“ã¨ã‚’å¥½ã¿ã¾ã™",
                    option_b_trait: "I",
                    version: "1.0",
                    is_active: true
                },
                {
                    question_number: 2,
                    dimension: "S_N",
                    question_text_en: "Do you focus on details or the big picture?",
                    question_text_ja: "ç´°éƒ¨ã«æ³¨ç›®ã—ã¾ã™ã‹ã€ãã‚Œã¨ã‚‚å…¨ä½“åƒã«æ³¨ç›®ã—ã¾ã™ã‹ï¼Ÿ",
                    option_a_en: "I focus on specific details and facts",
                    option_a_ja: "å…·ä½“çš„ãªè©³ç´°ã¨äº‹å®Ÿã«æ³¨ç›®ã—ã¾ã™",
                    option_a_trait: "S",
                    option_b_en: "I focus on patterns and possibilities",
                    option_b_ja: "ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨å¯èƒ½æ€§ã«æ³¨ç›®ã—ã¾ã™",
                    option_b_trait: "N",
                    version: "1.0",
                    is_active: true
                },
                {
                    question_number: 3,
                    dimension: "T_F",
                    question_text_en: "When making decisions, do you rely more on logic or feelings?",
                    question_text_ja: "æ±ºå®šã‚’ä¸‹ã™ã¨ãã€è«–ç†ã¨æ„Ÿæƒ…ã®ã©ã¡ã‚‰ã«ã‚ˆã‚Šå¤šãä¾å­˜ã—ã¾ã™ã‹ï¼Ÿ",
                    option_a_en: "I rely on logical analysis and objective facts",
                    option_a_ja: "è«–ç†çš„åˆ†æã¨å®¢è¦³çš„äº‹å®Ÿã«ä¾å­˜ã—ã¾ã™",
                    option_a_trait: "T",
                    option_b_en: "I consider people's feelings and values",
                    option_b_ja: "äººã€…ã®æ„Ÿæƒ…ã¨ä¾¡å€¤è¦³ã‚’è€ƒæ…®ã—ã¾ã™",
                    option_b_trait: "F",
                    version: "1.0",
                    is_active: true
                },
                {
                    question_number: 4,
                    dimension: "J_P",
                    question_text_en: "Do you prefer planned or spontaneous activities?",
                    question_text_ja: "è¨ˆç”»çš„ãªæ´»å‹•ã¨è‡ªç™ºçš„ãªæ´»å‹•ã€ã©ã¡ã‚‰ã‚’å¥½ã¿ã¾ã™ã‹ï¼Ÿ",
                    option_a_en: "I prefer planned and organized activities",
                    option_a_ja: "è¨ˆç”»çš„ã§çµ„ç¹”åŒ–ã•ã‚ŒãŸæ´»å‹•ã‚’å¥½ã¿ã¾ã™",
                    option_a_trait: "J",
                    option_b_en: "I prefer spontaneous and flexible activities",
                    option_b_ja: "è‡ªç™ºçš„ã§æŸ”è»Ÿãªæ´»å‹•ã‚’å¥½ã¿ã¾ã™",
                    option_b_trait: "P",
                    version: "1.0",
                    is_active: true
                },
                {
                    question_number: 5,
                    dimension: "E_I",
                    question_text_en: "How do you recharge your energy?",
                    question_text_ja: "ã©ã®ã‚ˆã†ã«ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’å……é›»ã—ã¾ã™ã‹ï¼Ÿ",
                    option_a_en: "By being around people and socializing",
                    option_a_ja: "äººã€…ã¨ä¸€ç·’ã«ã„ã¦ç¤¾äº¤ã™ã‚‹ã“ã¨ã§",
                    option_a_trait: "E",
                    option_b_en: "By spending quiet time alone",
                    option_b_ja: "ä¸€äººã§é™ã‹ãªæ™‚é–“ã‚’éã”ã™ã“ã¨ã§",
                    option_b_trait: "I",
                    version: "1.0",
                    is_active: true
                }
            ];

            try {
                showResult('questions-result', 'â³ Adding sample questions...', 'warning');

                const response = await fetch(`${BACKEND_URL}/api/mbti/admin/questions/bulk`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(sampleQuestions)
                });

                if (response.ok) {
                    const result = await response.json();
                    showResult('questions-result', `âœ… Successfully added ${result.length} MBTI questions!`);
                } else if (response.status === 403) {
                    showResult('questions-result', 'âŒ You need admin access to add questions. Please ask an admin to run this step.', 'error');
                } else {
                    const error = await response.text();
                    showResult('questions-result', `âŒ Failed to add questions: ${response.status} - ${error}`, 'error');
                }
            } catch (error) {
                showResult('questions-result', `âŒ Error adding questions: ${error.message}`, 'error');
            }
        }

        async function testFinalState() {
            const token = document.getElementById('auth-token').value.trim();
            if (!token) {
                showResult('final-result', 'âŒ Please test authentication first', 'error');
                return;
            }

            try {
                // Check progress
                const progressResponse = await fetch(`${BACKEND_URL}/api/mbti/progress`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!progressResponse.ok) {
                    showResult('final-result', 'âŒ Cannot check progress', 'error');
                    return;
                }

                const progress = await progressResponse.json();

                // Try to get questions
                const questionsResponse = await fetch(`${BACKEND_URL}/api/mbti/questions?language=ja`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                let questionsStatus = '';
                if (questionsResponse.ok) {
                    const questions = await questionsResponse.json();
                    questionsStatus = `âœ… ${questions.length} questions available`;
                } else {
                    questionsStatus = `âŒ Questions not available (${questionsResponse.status})`;
                }

                const isFixed = progress.status === 'in_progress' && questionsResponse.ok;

                showResult('final-result',
                    `<h3>Final State Check:</h3>
                    MBTI Status: ${progress.status}<br>
                    Completion: ${progress.completion_percentage}%<br>
                    ${questionsStatus}<br><br>
                    <strong>${isFixed
                        ? 'ğŸ‰ MBTI is now FIXED! Go back to your frontend and try the test button!'
                        : 'âš ï¸ Still needs work. Make sure questions are added and test is reset.'}</strong><br><br>
                    <em>If fixed, refresh your frontend page and the MBTI button should work properly.</em>`);

            } catch (error) {
                showResult('final-result', `âŒ Error testing final state: ${error.message}`, 'error');
            }
        }
    </script>

    <div class="section">
        <h2>ğŸ“ Instructions Summary</h2>
        <div class="step">1. Paste your auth token and test authentication</div>
        <div class="step">2. Check current state to confirm the problem</div>
        <div class="step">3. Reset your test state to clear the stuck record</div>
        <div class="step">4. Add sample questions (admin access required)</div>
        <div class="step">5. Verify the fix worked</div>
        <div class="step">6. Go back to frontend, refresh page, and test MBTI button</div>
    </div>
</body>
</html>